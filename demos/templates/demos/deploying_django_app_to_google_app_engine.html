{# demos/templates/demos/deploying_django_app_to_google_app_engine.html #}
{% extends 'portfolio/base.html' %}
{% load static %}

{% block title %}{{ page_title|default:"Deploying Django to Google App Engine" }} - Portfolio{% endblock %}
{% block meta_description %}{{ meta_description|default:"Guide on deploying Django applications to Google App Engine (GAE) Standard Environment using the gcloud CLI." }}{% endblock %}
{% block meta_keywords %}{{ meta_keywords|default:"Django, Google App Engine, GAE, Deployment, Guide, PaaS, GCP, Cloud SQL, Cloud Storage" }}{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-12">

    <header class="mb-10 text-center">
        {# Gradient heading #}
        <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-blue-600 via-green-500 to-yellow-400 dark:from-blue-400 dark:via-green-400 dark:to-yellow-300 bg-clip-text text-transparent">
            {{ page_title|default:"Deploying Django to Google App Engine" }}
        </h1>
        <p class="text-lg text-gray-600 dark:text-gray-400">A step-by-step guide for the Standard Environment using the gcloud CLI.</p>
    </header>

    <main class="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-6 md:p-8 rounded-lg shadow-lg dark:shadow-green-900/20 transition-colors duration-300 ease-in-out">
        {# Use prose for overall text formatting #}
        <div class="prose prose-indigo dark:prose-invert lg:prose-lg max-w-none text-gray-700 dark:text-gray-300 leading-relaxed space-y-8">

            <section id="prerequisites">
                <h2 class="!text-2xl !font-semibold !border-b !border-gray-300 dark:!border-gray-700 !pb-2 !mb-4 text-gray-800 dark:text-gray-100">1. Prerequisites</h2>
                <ul class="!list-disc !list-inside !space-y-2 !pl-4">
                    <li>A working Django project committed to a Git repository (optional but good practice).</li>
                    <li>Python and Pip installed locally.</li>
                    <li>A <a href="https://cloud.google.com/free/" target="_blank" rel="noopener noreferrer">Google Cloud Platform (GCP) account</a> with billing enabled (App Engine has a free tier, but billing needs to be enabled for project creation).</li>
                    <li>A GCP Project created. Note your Project ID.</li>
                    <li>The <a href="https://cloud.google.com/sdk/docs/install" target="_blank" rel="noopener noreferrer">Google Cloud SDK (gcloud CLI)</a> installed and initialized (`gcloud init`).</li>
                    <li>Git installed locally.</li>
                    <li>Gunicorn installed in your project: <code>pip install gunicorn</code> (Add to `requirements.txt`).</li>
                </ul>
            </section>

            <section id="config-files">
                <h2 class="!text-2xl !font-semibold !border-b !border-gray-300 dark:!border-gray-700 !pb-2 !mb-4 text-gray-800 dark:text-gray-100">2. Configuration Files</h2>
                <p>Create/update these files in the root directory of your Django project (where `manage.py` is located).</p>

                <div class="space-y-6">
                    <div>
                        <h3 class="!text-xl !font-semibold !mb-2">app.yaml</h3>
                        <p class="!text-sm">The main configuration file for App Engine. Defines runtime, entrypoint, environment variables, scaling, and handlers.</p>
                        <pre><code class="language-yaml">
runtime: python311 # Specify Python version (e.g., python39, python310, python311, python312)
entrypoint: gunicorn -b :$PORT your_project_name.wsgi:application # How to start your app

instance_class: F1 # Basic instance class (check App Engine docs for options)

# Reference secrets from Secret Manager (Recommended)
# env_variables:
#   SECRET_KEY: ${sm://projects/YOUR_PROJECT_ID/secrets/YOUR_SECRET_KEY_NAME/versions/latest}
#   DB_PASSWORD: ${sm://projects/YOUR_PROJECT_ID/secrets/YOUR_DB_PASSWORD_NAME/versions/latest}
#   DB_USER: ${sm://projects/YOUR_PROJECT_ID/secrets/YOUR_DB_USER_NAME/versions/latest}
#   DB_NAME: ${sm://projects/YOUR_PROJECT_ID/secrets/YOUR_DB_NAME/versions/latest}
#   # Cloud SQL Connection Name (usually safe to put here)
#   DB_HOST: '/cloudsql/your-gcp-project-id:your-region:your-instance-name'
#   DJANGO_SETTINGS_MODULE: 'your_project_name.settings'
#   # Add other non-sensitive env vars here if needed
#   # DJANGO_DEBUG: 'False' # Can be set here or in settings.py

# Or set non-sensitive vars directly (Secrets preferred for sensitive data)
env_variables:
  DJANGO_SETTINGS_MODULE: 'your_project_name.settings'
  DB_HOST: '/cloudsql/your-gcp-project-id:your-region:your-instance-name'
  # Avoid putting secrets directly here!

handlers:
# Route static files (Choose one option)

# Option 1: Serve directly via App Engine (simpler, less performant)
# Ensure 'staticfiles/' matches your STATIC_ROOT setting
- url: /static
  static_dir: staticfiles/

# Option 2: Route to GCS (Recommended for performance)
# Requires django-storages setup in settings.py and collectstatic before deploy
# - url: /static/(.*)
#   static_files: staticfiles/\1 # Maps URL path to collected files
#   upload: staticfiles/.* # Regex to upload collected files

# Route media files (if using GCS - requires django-storages)
# - url: /media/(.*)
#   static_files: mediafiles/\1 # Assumes media files are collected/uploaded to 'mediafiles/' in bucket
#   upload: mediafiles/.*

# Route all other requests to the Django application
- url: /.*
  script: auto
  secure: always # Optional: Redirect HTTP to HTTPS

# Optional: Automatic Scaling settings
# automatic_scaling:
#   target_cpu_utilization: 0.65
#   min_instances: 0 # Can scale to zero on free tier
#   max_instances: 1 # Adjust as needed
                        </code></pre>
                        <p class="!text-xs !mt-2">
                            Replace placeholders (`python311`, `your_project_name`, Cloud SQL connection name, secret names, project ID) with your actual values.<br>
                            <strong>Security:</strong> Use <a href="https://cloud.google.com/secret-manager" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline">Secret Manager</a> for sensitive values like `SECRET_KEY`, `DB_PASSWORD`, `DB_USER`, `DB_NAME` and reference them using the `${sm://...}` syntax.
                        </p>
                    </div>

                    <div>
                        <h3 class="!text-xl !font-semibold !mb-2">requirements.txt</h3>
                        <p class="!text-sm">Lists Python dependencies.</p>
                        <pre><code class="language-bash">pip freeze > requirements.txt</code></pre>
                        <p class="!text-xs !mt-2">Ensure it includes:</p>
                        <ul class="!list-disc !list-inside !space-y-1 !pl-4 !text-xs">
                            <li><code>Django</code></li>
                            <li><code>gunicorn</code></li>
                            <li><code>psycopg2-binary</code> (If using Cloud SQL for PostgreSQL)</li>
                            <li><code>mysqlclient</code> (If using Cloud SQL for MySQL)</li>
                            <li><code>django-storages[google]</code> (If using Cloud Storage)</li>
                            <li><code>google-cloud-secret-manager</code> (If loading secrets in `settings.py`)</li>
                            <li>Any other project dependencies.</li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="!text-xl !font-semibold !mb-2">.gcloudignore</h3>
                        <p class="!text-sm">Specifies files/directories NOT to upload during deployment.</p>
                        <pre><code class="language-text">
# Default .gcloudignore file generated by gcloud can be a good starting point
# Add files/directories specific to your project that aren't needed for deployment

.gcloudignore
.git
.gitignore
venv/
env/
__pycache__/
*.pyc
*.log
*.pot
*.pt
*.swp
db.sqlite3*
local_settings.py
*.env
.env
/mediafiles/ # Exclude local media if using cloud storage
/staticfiles/ # Exclude collected static files if serving via GCS/App Engine static handler
# Add other sensitive files or large data directories
                        </code></pre>
                        <p class="!text-xs !mt-2">Start with `gcloud init` generated file or create manually. Be sure to exclude secrets and local-only files.</p>
                    </div>
                </div>
            </section>

            <section id="django-settings">
                <h2 class="!text-2xl !font-semibold !border-b !border-gray-300 dark:!border-gray-700 !pb-2 !mb-4 text-gray-800 dark:text-gray-100">3. Django Settings (`settings.py`)</h2>
                <p>Modify your project's `settings.py` for Google Cloud compatibility.</p>

                <ul class="!list-disc !list-inside !space-y-4 !pl-4">
                    <li>
                        <strong>SECRET_KEY:</strong> Load from Secret Manager (recommended) or environment variable (set via Secret Manager reference in `app.yaml`).
                        <pre><code class="language-python">
# settings.py
import os
from google.cloud import secretmanager # If loading directly

# Option 1: Load directly from Secret Manager (requires permissions)
# def get_secret(secret_id, project_id="your-gcp-project-id", version_id="latest"):
#     try:
#         client = secretmanager.SecretManagerServiceClient()
#         name = f"projects/{project_id}/secrets/{secret_id}/versions/{version_id}"
#         response = client.access_secret_version(request={"name": name})
#         return response.payload.data.decode("UTF-8")
#     except Exception as e:
#         # Handle error appropriately, maybe raise ImproperlyConfigured
#         print(f"Error accessing secret: {e}")
#         return None # Or raise error
#
# SECRET_KEY = get_secret("YOUR_SECRET_KEY_NAME_IN_SECRET_MANAGER") or "local-fallback-key-if-needed"

# Option 2: Load from environment variable set via app.yaml referencing Secret Manager
SECRET_KEY = os.environ.get('SECRET_KEY', 'your-local-dev-secret-key') # Fallback for local
                        </code></pre>
                    </li>
                    <li>
                        <strong>DEBUG:</strong> Set based on App Engine environment.
                        <pre><code class="language-python">
# settings.py
# Defaults to True for local dev, False on App Engine Standard
DEBUG = os.environ.get('GAE_ENV', '') != 'standard'
                        </code></pre>
                    </li>
                    <li>
                        <strong>ALLOWED_HOSTS:</strong> Get from environment variables or App Engine metadata.
                        <pre><code class="language-python">
# settings.py
ALLOWED_HOSTS = []
# GAE_APPLICATION format is 'g~project-id' or 's~project-id'
gae_app_id = os.environ.get('GAE_APPLICATION', '')
if gae_app_id:
    project_id = gae_app_id.split('~')[-1]
    # Default App Engine URL
    ALLOWED_HOSTS.append(f'{project_id}.appspot.com')
    # Default service URL (for standard env)
    ALLOWED_HOSTS.append(f'{project_id}.uc.r.appspot.com') # Check region prefix if not us-central (uc)

# Add custom domain if configured via environment variable
custom_domain = os.environ.get('CUSTOM_DOMAIN')
if custom_domain:
    ALLOWED_HOSTS.append(custom_domain)

# Add localhost and 127.0.0.1 for local development if DEBUG is True
if DEBUG:
   ALLOWED_HOSTS.extend(['localhost', '127.0.0.1'])

# Ensure ALLOWED_HOSTS is not empty in production
if not DEBUG and not ALLOWED_HOSTS:
    # Log a warning or raise an error if no hosts are allowed in production
    # For safety, you might add a default if absolutely sure, but explicit config is better.
    # ALLOWED_HOSTS.append('.appspot.com') # Example fallback (less secure)
    import warnings
    warnings.warn("ALLOWED_HOSTS is empty in production environment!")

                        </code></pre>
                    </li>
                    <li>
                        <strong>Database (Cloud SQL):</strong> Connect via Unix socket in production.
                        <pre><code class="language-python">
# settings.py
import os

if os.getenv('GAE_ENV', '').startswith('standard'):
    # Production settings: Connect via Cloud SQL Unix socket
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.postgresql', # Or mysql
            # Get connection name from DB_HOST env var set in app.yaml
            'HOST': os.environ.get('DB_HOST'), # e.g., /cloudsql/project-id:region:instance-id
            'USER': os.environ.get('DB_USER'), # Set via Secret Manager/env_var
            'PASSWORD': os.environ.get('DB_PASSWORD'), # Set via Secret Manager/env_var
            'NAME': os.environ.get('DB_NAME'), # Set via Secret Manager/env_var
        }
    }
else:
    # Local development settings (e.g., SQLite or local Postgres/MySQL)
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.sqlite3',
            'NAME': BASE_DIR / 'db.sqlite3',
        }
    }
                        </code></pre>
                        Ensure `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME` are set securely as environment variables (referenced from Secret Manager in `app.yaml` is best).
                    </li>
                     <li>
                        <strong>Static & Media Files (Cloud Storage - Recommended):</strong>
                        <pre><code class="language-python">
# settings.py
import os

# Static files (CSS, JavaScript, Images)
STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles') # Target for collectstatic

# Media files (User Uploads)
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'mediafiles') # Local media root during development

# Google Cloud Storage Settings (Production - when GAE_ENV is set)
if os.getenv('GAE_ENV', '').startswith('standard'):
    # Ensure django-storages[google] is installed
    GS_BUCKET_NAME = os.environ.get('GS_BUCKET_NAME') # Set in app.yaml or via Secret Manager
    if GS_BUCKET_NAME:
        STATICFILES_STORAGE = 'storages.backends.gcloud.GoogleCloudStorage'
        DEFAULT_FILE_STORAGE = 'storages.backends.gcloud.GoogleCloudStorage' # For Media files

        # Define URLs based on bucket name (adjust if using CDN or custom domain)
        STATIC_URL = f'https://storage.googleapis.com/{GS_BUCKET_NAME}/static/'
        MEDIA_URL = f'https://storage.googleapis.com/{GS_BUCKET_NAME}/media/'

        # Optional: Set specific locations within the bucket
        # GS_LOCATION = 'static' # Handled by STATIC_URL path
        # GS_MEDIA_LOCATION = 'media' # Handled by MEDIA_URL path
        # GS_DEFAULT_ACL = 'publicRead' # Make files publicly readable by default
    else:
        # Log a warning if running on GAE but bucket name isn't set
        import warnings
        warnings.warn("Running on App Engine but GS_BUCKET_NAME not set. Static/Media files might not work correctly.")
else:
    # Local development storage settings (Django default or others)
    pass

# Important: Ensure your App Engine service account has permissions
# to write to the GCS bucket (e.g., Storage Object Admin role).
                        </code></pre>
                        Replace `your-gcs-bucket-name` (ideally load from env/secret). Run `collectstatic` before deploying.
                    </li>
                    <li>
                        **Security Middleware (Production):** Enable HTTPS-related settings. App Engine handles SSL termination, so `SECURE_PROXY_SSL_HEADER` is often needed.
                        <pre><code class="language-python">
# settings.py
if os.getenv('GAE_ENV', '').startswith('standard'):
    SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
    SECURE_SSL_REDIRECT = True
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    # Consider HSTS settings carefully
    # SECURE_HSTS_SECONDS = 31536000 # 1 year
    # SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    # SECURE_HSTS_PRELOAD = True
                        </code></pre>
                    </li>
                </ul>
            </section>

            <section id="deployment">
                <h2 class="!text-2xl !font-semibold !border-b !border-gray-300 dark:!border-gray-700 !pb-2 !mb-4 text-gray-800 dark:text-gray-100">4. Deployment Steps</h2>
                <ol class="!list-decimal !list-inside !space-y-4 !pl-4">
                    <li>
                        <strong>Set up Google Cloud Project:</strong> Ensure you've run `gcloud init` and selected the correct GCP project.
                        <pre><code class="language-bash">gcloud config set project YOUR_PROJECT_ID</code></pre>
                    </li>
                     <li>
                        <strong>Enable APIs:</strong> Ensure Cloud Build API, Cloud SQL Admin API (if using Cloud SQL), Secret Manager API, and Cloud Storage API (if using GCS) are enabled for your project.
                        <pre><code class="language-bash">
gcloud services enable cloudbuild.googleapis.com
gcloud services enable sqladmin.googleapis.com
gcloud services enable secretmanager.googleapis.com
gcloud services enable storage-component.googleapis.com
gcloud services enable appengine.googleapis.com
                        </code></pre>
                    </li>
                    <li>
                        <strong>Set up Secrets:</strong> Create secrets for `SECRET_KEY`, `DB_PASSWORD`, etc. in Secret Manager via GCP Console or `gcloud secrets create ...`. Grant the App Engine service account (`YOUR_PROJECT_ID@appspot.gserviceaccount.com`) access (Secret Manager Secret Accessor role). Update `app.yaml` to reference them or load them in `settings.py`.
                    </li>
                    <li>
                        <strong>Run `collectstatic` Locally (If using GCS):</strong> Collect static files into the directory specified by `STATIC_ROOT` (e.g., `staticfiles/`).
                        <pre><code class="language-bash">python manage.py collectstatic --noinput</code></pre>
                    </li>
                    <li>
                        <strong>Deploy the Application:</strong> From your project root directory (where `app.yaml` is).
                        <pre><code class="language-bash">gcloud app deploy</code></pre>
                        <p class="!text-xs !mt-1">Follow the prompts. This builds your app using Cloud Build and deploys it.</p>
                        <p class="!text-xs !mt-1">Use `gcloud app deploy --version=v2 --no-promote` to deploy without immediately routing traffic.</p>
                    </li>
                    <li>
                        <strong>Run Migrations:</strong> Connect via Cloud Shell or use the Cloud SQL Proxy locally.
                        <p class="!text-sm !font-semibold !mt-2 !mb-1">Method: Using Cloud Shell</p>
                        <ol class="!list-alpha !list-inside !space-y-1 !pl-4 !text-xs">
                            <li>Open Cloud Shell in GCP Console.</li>
                            <li>Clone repo: `git clone ...` & `cd your-repo`</li>
                            <li>Setup venv & install: `python -m venv env && source env/bin/activate && pip install -r requirements.txt`</li>
                            <li>Set env vars (DB creds, SECRET_KEY) OR ensure `settings.py` loads them from Secret Manager.</li>
                            <li>Start Proxy: `./cloud_sql_proxy -instances=YOUR_INSTANCE_CONNECTION_NAME=tcp:5432 &` (Use 3306 for MySQL. Ensure `settings.py` uses `127.0.0.1` as HOST when proxy runs).</li>
                            <li>Migrate: `python manage.py migrate`</li>
                            <li>Create Superuser: `python manage.py createsuperuser`</li>
                            <li>Stop proxy (find process ID `ps aux | grep cloud_sql_proxy` and use `kill [PID]`).</li>
                        </ol>
                    </li>
                    <li>
                        <strong>Browse your app:</strong>
                        <pre><code class="language-bash">gcloud app browse</code></pre>
                    </li>
                </ol>
            </section>

            <section id="troubleshooting">
                <h2 class="!text-2xl !font-semibold !border-b !border-gray-300 dark:!border-gray-700 !pb-2 !mb-4 text-gray-800 dark:text-gray-100">5. Troubleshooting</h2>
                <ul class="!list-disc !list-inside !space-y-2 !pl-4">
                    <li>
                        <strong>Check Logs:</strong> Use GCP Console (Logging > Logs Explorer) or gcloud CLI.
                        <pre><code class="language-bash">
# Stream logs for default service
gcloud app logs tail -s default
# Read recent logs
gcloud app logs read
                        </code></pre>
                    </li>
                     <li><strong>Build Failures:</strong> Check Cloud Build history in GCP Console. Often `requirements.txt` errors or missing files in upload.</li>
                    <li><strong>500 Server Errors:</strong> Check App Engine request logs (`stdout`, `stderr`) for Django tracebacks. Common: DB connection, missing secrets/env vars, `ALLOWED_HOSTS`, `settings.py` errors.</li>
                    <li><strong>Static Files Not Loading:</strong> If direct serving: check `static_dir` in `app.yaml`. If GCS: check bucket permissions, `STATICFILES_STORAGE`/`GS_BUCKET_NAME` settings, ensure `collectstatic` ran *before* deploy, check `STATIC_URL`.</li>
                    <li><strong>Database Connection Issues:</strong> Verify Cloud SQL instance/proxy running, connection name correct, DB user/pass correct & accessible, Cloud SQL Admin API enabled. Check App Engine service account has "Cloud SQL Client" IAM role.</li>
                    <li><strong>Permissions Errors:</strong> Ensure App Engine service account (`YOUR_PROJECT_ID@appspot.gserviceaccount.com`) has necessary IAM roles (Cloud SQL Client, Secret Manager Secret Accessor, Storage Object Admin/Viewer).</li>
                    <li>Consult the <a href="https://cloud.google.com/appengine/docs/standard/python3/runtime" target="_blank" rel="noopener noreferrer">App Engine Standard Python 3 Docs</a>.</li>
                </ul>
            </section>

        </div>{# End Prose #}
    </main>

    <div class="text-center mt-12">
        <a href="{% url 'portfolio:index' %}" class="text-blue-600 dark:text-blue-400 hover:underline focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900 rounded">&larr; Back to Home</a>
    </div>

</div>
{% endblock %}
