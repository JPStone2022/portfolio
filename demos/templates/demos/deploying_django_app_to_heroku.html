{# demos/templates/demos/deploying_django_app_to_heroku.html #}
{% extends 'portfolio/base.html' %}
{% load static %}

{% block title %}{{ page_title|default:"Deploying Django to Heroku" }} - Portfolio{% endblock %}
{% block meta_description %}{{ meta_description|default:"Step-by-step guide for deploying Django applications to the Heroku platform using the Heroku CLI." }}{% endblock %}
{% block meta_keywords %}{{ meta_keywords|default:"Django, Heroku, Deployment, Guide, PaaS, Python, Gunicorn, WhiteNoise" }}{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-12">

    <header class="mb-10 text-center">
        {# Gradient heading #}
        <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 dark:from-indigo-400 dark:via-purple-400 dark:to-pink-400 bg-clip-text text-transparent">
            {{ page_title|default:"Deploying Django to Heroku" }}
        </h1>
        <p class="text-lg text-gray-600 dark:text-gray-400">A step-by-step guide to get your Django app live.</p>
    </header>

    <main class="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-6 md:p-8 rounded-lg shadow-lg dark:shadow-purple-900/20 transition-colors duration-300 ease-in-out">
        {# Use prose for overall text formatting #}
        <div class="prose prose-indigo dark:prose-invert lg:prose-lg max-w-none text-gray-700 dark:text-gray-300 leading-relaxed space-y-8">

            <section id="prerequisites">
                <h2 class="!text-2xl !font-semibold !border-b !border-gray-300 dark:!border-gray-700 !pb-2 !mb-4 text-gray-800 dark:text-gray-100">1. Prerequisites</h2>
                <ul class="!list-disc !list-inside !space-y-2 !pl-4">
                    <li>A working Django project committed to a Git repository.</li>
                    <li>Python and Pip installed locally.</li>
                    <li>A <a href="https://signup.heroku.com/" target="_blank" rel="noopener noreferrer">Heroku account</a> (Free tier available).</li>
                    <li>The <a href="https://devcenter.heroku.com/articles/heroku-cli" target="_blank" rel="noopener noreferrer">Heroku CLI</a> installed and logged in (`heroku login`).</li>
                    <li>Git installed locally.</li>
                </ul>
            </section>

            <section id="config-files">
                <h2 class="!text-2xl !font-semibold !border-b !border-gray-300 dark:!border-gray-700 !pb-2 !mb-4 text-gray-800 dark:text-gray-100">2. Configuration Files</h2>
                <p>Create these files in the root directory of your Django project (where `manage.py` is located).</p>

                <div class="space-y-6">
                    <div>
                        <h3 class="!text-xl !font-semibold !mb-2">Procfile</h3>
                        <p class="!text-sm">Tells Heroku how to run your web process. Typically uses Gunicorn.</p>
                        <pre><code class="language-yaml">web: gunicorn your_project_name.wsgi --log-file -</code></pre>
                        <p class="!text-xs !mt-2">Replace `your_project_name` with the actual name of your Django project directory (the one containing `wsgi.py`).</p>
                        <p class="!text-xs !mt-1">Install Gunicorn: <code>pip install gunicorn</code> (and add to `requirements.txt`).</p>
                    </div>

                    <div>
                        <h3 class="!text-xl !font-semibold !mb-2">requirements.txt</h3>
                        <p class="!text-sm">Lists all Python dependencies Heroku needs to install.</p>
                        <pre><code class="language-bash">pip freeze > requirements.txt</code></pre>
                        <p class="!text-xs !mt-2">Ensure it includes:</p>
                        <ul class="!list-disc !list-inside !space-y-1 !pl-4 !text-xs">
                            <li><code>Django</code></li>
                            <li><code>gunicorn</code></li>
                            <li><code>django-heroku</code> (Optional but recommended)</li>
                            <li><code>psycopg2-binary</code> (If using Heroku Postgres)</li>
                            <li><code>whitenoise</code> (For static files)</li>
                            <li><code>dj-database-url</code> (If configuring DB manually)</li>
                            <li>Any other project dependencies.</li>
                        </ul>
                        <p class="!text-xs !mt-1">If using `django-heroku`, install it: <code>pip install django-heroku</code></p>
                    </div>

                    <div>
                        <h3 class="!text-xl !font-semibold !mb-2">runtime.txt</h3>
                        <p class="!text-sm">Specifies the Python version Heroku should use.</p>
                        <pre><code class="language-text">python-3.11.5</code></pre> {# Example version #}
                        <p class="!text-xs !mt-2">Replace with the specific Python version you are using (check with <code>python --version</code>). Match a version <a href="https://devcenter.heroku.com/articles/python-support#supported-runtimes" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline">Heroku supports</a>.</p>
                    </div>
                </div>
            </section>

            <section id="django-settings">
                <h2 class="!text-2xl !font-semibold !border-b !border-gray-300 dark:!border-gray-700 !pb-2 !mb-4 text-gray-800 dark:text-gray-100">3. Django Settings (`settings.py`)</h2>
                <p>Modify your project's `settings.py` file for Heroku compatibility.</p>

                <div class="space-y-6">
                    <div>
                        <h3 class="!text-xl !font-semibold !mb-2">Using `django-heroku` (Recommended)</h3>
                        <p class="!text-sm">If you installed `django-heroku`, add this line at the very bottom of your `settings.py`:</p>
                        <pre><code class="language-python">
# settings.py (at the very bottom)
import django_heroku
import os # Ensure os is imported

# Activate Django-Heroku.
# Note: This might override some settings above it, like DATABASES or STATICFILES_STORAGE
# Ensure it's placed correctly relative to your manual overrides if any.
django_heroku.settings(locals())

# Optional: If django-heroku's default logging is too verbose, you can override it AFTERWARDS
# For example, to reduce logging level:
# if os.environ.get('DYNO'): # Check if running on Heroku
#     LOGGING['loggers']['django']['level'] = 'WARNING'
#     LOGGING['loggers']['django.request']['level'] = 'WARNING'
                        </code></pre>
                        <p class="!text-xs !mt-2">This automatically configures database URLs (from `DATABASE_URL` env var), `ALLOWED_HOSTS`, static files (using WhiteNoise), logging, and `SECRET_KEY` (if `SECRET_KEY` env var is set). It assumes you're using Heroku Postgres if `DATABASE_URL` is present.</p>
                    </div>

                    <div>
                        <h3 class="!text-xl !font-semibold !mb-2">Manual Configuration (If not using `django-heroku`)</h3>
                        <p class="!text-sm">If configuring manually, ensure these are set:</p>
                        <ul class="!list-disc !list-inside !space-y-2 !pl-4">
                            <li>
                                <strong>SECRET_KEY:</strong> Load from environment variables (set via `heroku config:set`).
                                <pre><code class="language-python">
# settings.py
import os
SECRET_KEY = os.environ.get('SECRET_KEY', 'your-local-dev-secret-key-fallback')
                                </code></pre>
                            </li>
                            <li>
                                <strong>DEBUG:</strong> Set to `False` in production.
                                <pre><code class="language-python">
# settings.py
DEBUG = os.environ.get('DEBUG', 'False') == 'True' # Defaults to False
                                </code></pre>
                            </li>
                            <li>
                                <strong>ALLOWED_HOSTS:</strong> Allow your Heroku app domain and custom domain.
                                <pre><code class="language-python">
# settings.py
ALLOWED_HOSTS = []
HEROKU_APP_NAME = os.environ.get('HEROKU_APP_NAME') # Set this config var on Heroku
if HEROKU_APP_NAME:
    ALLOWED_HOSTS.append(f'{HEROKU_APP_NAME}.herokuapp.com')
# Add custom domain if you have one
# CUSTOM_DOMAIN = os.environ.get('CUSTOM_DOMAIN')
# if CUSTOM_DOMAIN:
#     ALLOWED_HOSTS.append(CUSTOM_DOMAIN)

if DEBUG: # Allow local hosts during development
    ALLOWED_HOSTS.extend(['localhost', '127.0.0.1'])

if not DEBUG and not ALLOWED_HOSTS:
    import warnings
    warnings.warn("ALLOWED_HOSTS is empty in production environment!")
                                </code></pre>
                            </li>
                            <li>
                                <strong>Database:</strong> Use `dj-database-url` to parse the `DATABASE_URL` environment variable set by Heroku Postgres.
                                <pre><code class="language-python">
# settings.py
import dj_database_url
import os

DATABASES = {'default': {}} # Start with empty dict

# Get DATABASE_URL from environment, default to local SQLite if not found
db_url = os.environ.get('DATABASE_URL')
if db_url:
    DATABASES['default'] = dj_database_url.config(conn_max_age=600, ssl_require=True)
else:
    # Fallback for local development (e.g., SQLite)
    DATABASES['default'] = {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
                                </code></pre>
                                Ensure `ssl_require=True` for Heroku Postgres.
                            </li>
                            <li>
                                **Static Files (WhiteNoise):** Configure manually as described in the next section.
                            </li>
                        </ul>
                    </div>
                </div>
            </section>

             <section id="static-files">
                <h2 class="!text-2xl !font-semibold !border-b !border-gray-300 dark:!border-gray-700 !pb-2 !mb-4 text-gray-800 dark:text-gray-100">4. Static Files Handling (WhiteNoise)</h2>
                 <p>Configure Django to serve static files correctly in production using WhiteNoise. (Note: `django-heroku` does this automatically).</p>
                 <ol class="!list-decimal !list-inside !space-y-2 !pl-4">
                     <li>Install WhiteNoise: <code>pip install whitenoise</code> (and add to `requirements.txt`).</li>
                     <li>
                         Modify `settings.py` (if not using `django-heroku`):
                         <pre><code class="language-python">
# settings.py
import os # Ensure os is imported

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware', # Add WhiteNoise right after SecurityMiddleware
    # ... other middleware ...
]

# Static files (CSS, JavaScript, Images)
STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles') # Directory where collectstatic gathers files

# Optional: Add directories where Django should look for static files
# STATICFILES_DIRS = [os.path.join(BASE_DIR, 'your_project_static_dir')]

# Whitenoise storage setting (recommended for compression/caching)
# Use STORAGES for Django 4.2+
STORAGES = {
    "staticfiles": {
        "BACKEND": "whitenoise.storage.CompressedManifestStaticFilesStorage",
    },
    # Keep default storage if not using external media storage
    "default": {
        "BACKEND": "django.core.files.storage.FileSystemStorage",
    },
}
# For Django < 4.2, use this instead of STORAGES["staticfiles"]:
# STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
                         </code></pre>
                     </li>
                 </ol>
                 <p class="!text-xs !mt-2">Heroku runs `collectstatic` automatically during deployment if it detects `manage.py` unless disabled.</p>
            </section>

            <section id="deployment">
                <h2 class="!text-2xl !font-semibold !border-b !border-gray-300 dark:!border-gray-700 !pb-2 !mb-4 text-gray-800 dark:text-gray-100">5. Deployment Steps</h2>
                <ol class="!list-decimal !list-inside !space-y-4 !pl-4">
                    <li>
                        <strong>Commit changes to Git:</strong>
                        <pre><code class="language-bash">
git add .
git commit -m "Configure project for Heroku deployment"
                        </code></pre>
                    </li>
                    <li>
                        <strong>Create Heroku app:</strong>
                        <pre><code class="language-bash">heroku create your-app-name</code></pre>
                        <p class="!text-xs !mt-1">Replace `your-app-name` with a unique name. If omitted, Heroku generates one.</p>
                    </li>
                    <li>
                        <strong>Add Heroku Postgres (if needed):</strong>
                        <pre><code class="language-bash">heroku addons:create heroku-postgresql:hobby-dev</code></pre>
                        <p class="!text-xs !mt-1">This adds the free tier database and sets the `DATABASE_URL` config var.</p>
                    </li>
                     <li>
                        <strong>Set Config Vars (Environment Variables):</strong>
                        <p class="!text-sm !mb-1">Set your `SECRET_KEY` and any other required environment variables via the Heroku Dashboard (Settings > Config Vars) or CLI.</p>
                        <pre><code class="language-bash">
# Example using CLI:
heroku config:set SECRET_KEY='your_VERY_strong_production_secret_key'
heroku config:set DJANGO_SETTINGS_MODULE='your_project_name.settings'
# Set HEROKU_APP_NAME if using manual ALLOWED_HOSTS config
heroku config:set HEROKU_APP_NAME='your-app-name'
# Set other variables like email passwords, API keys, etc.
# heroku config:set EMAIL_HOST_PASSWORD='your_email_password'
                        </code></pre>
                        <p class="!text-xs !mt-1">Generate a strong, unique secret key for production!</p>
                    </li>
                     <li>
                        <strong>Disable `collectstatic` during build (Recommended if using WhiteNoise):</strong>
                        <p class="!text-sm !mb-1">Prevent Heroku's default `collectstatic` if WhiteNoise handles serving.</p>
                        <pre><code class="language-bash">heroku config:set DISABLE_COLLECTSTATIC=1</code></pre>
                    </li>
                    <li>
                        <strong>Push to Heroku:</strong> Deploy your code.
                        <pre><code class="language-bash">git push heroku main</code></pre>
                        <p class="!text-xs !mt-1">Or `git push heroku master` if using the master branch.</p>
                    </li>
                    <li>
                        <strong>Run Migrations:</strong> Apply database changes on the Heroku server.
                        <pre><code class="language-bash">heroku run python manage.py migrate</code></pre>
                    </li>
                     <li>
                        <strong>Create Superuser (Optional):</strong>
                        <pre><code class="language-bash">heroku run python manage.py createsuperuser</code></pre>
                    </li>
                    <li>
                        <strong>Open your app:</strong>
                        <pre><code class="language-bash">heroku open</code></pre>
                    </li>
                </ol>
            </section>

            <section id="troubleshooting">
                <h2 class="!text-2xl !font-semibold !border-b !border-gray-300 dark:!border-gray-700 !pb-2 !mb-4 text-gray-800 dark:text-gray-100">6. Troubleshooting</h2>
                <ul class="!list-disc !list-inside !space-y-2 !pl-4">
                    <li>
                        <strong>Check logs:</strong> Essential for diagnosing issues.
                        <pre><code class="language-bash">
heroku logs --tail # View real-time logs
heroku logs        # View recent logs (add --num=100 for more lines)
                        </code></pre>
                    </li>
                    <li><strong>Application Error:</strong> Often related to failed migrations, missing config vars (check `heroku config`), issues in `Procfile` or `settings.py`. Check the logs!</li>
                    <li><strong>Static files (CSS/JS) not loading:</strong> Ensure WhiteNoise is configured correctly, `DISABLE_COLLECTSTATIC=1` is set, and `DEBUG` is `False`. Check logs for `collectstatic` errors during build if not disabled.</li>
                    <li><strong>Database connection issues:</strong> Verify `DATABASE_URL` is set correctly by Heroku Postgres addon and `psycopg2-binary` is in `requirements.txt`.</li>
                    <li><strong>H10 App Crashed / R10 Boot Timeout:</strong> Indicates the web process failed to start or timed out. Check logs for errors in Gunicorn, `wsgi.py`, missing dependencies, or port binding issues.</li>
                    <li>Consult the <a href="https://devcenter.heroku.com/articles/deploying-python" target="_blank" rel="noopener noreferrer">Heroku Dev Center for Python</a>.</li>
                </ul>
            </section>

        </div>{# End Prose #}
    </main>

    <div class="text-center mt-12">
        <a href="{% url 'portfolio:index' %}" class="text-blue-600 dark:text-blue-400 hover:underline focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900 rounded">&larr; Back to Home</a>
    </div>

</div>
{% endblock %}
